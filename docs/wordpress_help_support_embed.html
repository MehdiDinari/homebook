<div id="hb-help-support" class="hbhs" data-api-base="">
  <section class="hbhs-hero">
    <div class="hbhs-hero-left">
      <p class="hbhs-kicker">HomeBook</p>
      <h1>Aide & Support</h1>
      <p class="hbhs-sub">
        Trouve vite une reponse, ouvre un ticket de support, et suis les etapes de resolution.
      </p>
    </div>
    <div class="hbhs-hero-right">
      <label class="hbhs-search-wrap" for="hbhs-search">
        <span>Rechercher</span>
        <input id="hbhs-search" type="search" placeholder="Ex: paiement, notifications, cours, connexion..." />
      </label>
    </div>
  </section>

  <section class="hbhs-grid">
    <main class="hbhs-main">
      <article class="hbhs-card">
        <header class="hbhs-card-head">
          <h2>Acces rapide</h2>
          <p>Les sujets les plus utilises.</p>
        </header>
        <div class="hbhs-quick">
          <a href="#faq-compte" class="hbhs-chip">Compte & connexion</a>
          <a href="#faq-cours" class="hbhs-chip">Cours & sessions</a>
          <a href="#faq-paiement" class="hbhs-chip">Paiement & wallet</a>
          <a href="#faq-technique" class="hbhs-chip">Support technique</a>
        </div>
      </article>

      <article class="hbhs-card">
        <header class="hbhs-card-head">
          <h2>FAQ</h2>
          <p>Clique sur une question pour afficher la reponse.</p>
        </header>

        <section class="hbhs-faq-group" id="faq-compte" data-group-title="compte connexion profil">
          <h3>Compte & connexion</h3>
          <div class="hbhs-faq-item" data-search="mot de passe oublier connexion compte email">
            <button class="hbhs-faq-q" type="button" aria-expanded="false">
              J'ai oublie mon mot de passe, que faire ?
              <span>+</span>
            </button>
            <div class="hbhs-faq-a">
              Utilise la page de connexion, puis "Mot de passe oublie". Tu recevras un lien de reinitialisation par email.
            </div>
          </div>
          <div class="hbhs-faq-item" data-search="email profil modifier">
            <button class="hbhs-faq-q" type="button" aria-expanded="false">
              Comment modifier mon email de profil ?
              <span>+</span>
            </button>
            <div class="hbhs-faq-a">
              Ouvre Profil, mets a jour l'email, puis valide. Si l'adresse est deja utilisee, choisis une autre adresse.
            </div>
          </div>
          <div class="hbhs-faq-item" data-search="compte bloque tentative connexion">
            <button class="hbhs-faq-q" type="button" aria-expanded="false">
              Mon compte est bloque apres plusieurs tentatives.
              <span>+</span>
            </button>
            <div class="hbhs-faq-a">
              Attends quelques minutes puis reessaye. Si le blocage continue, ouvre un ticket avec ton email de compte.
            </div>
          </div>
        </section>

        <section class="hbhs-faq-group" id="faq-cours" data-group-title="cours sessions prof etudiant calendrier">
          <h3>Cours & sessions</h3>
          <div class="hbhs-faq-item" data-search="cours live session rejoindre">
            <button class="hbhs-faq-q" type="button" aria-expanded="false">
              Je ne vois pas le bouton pour rejoindre un live.
              <span>+</span>
            </button>
            <div class="hbhs-faq-a">
              Verifie l'horaire, recharge la page et assure-toi d'etre connecte avec le bon role (prof ou etudiant).
            </div>
          </div>
          <div class="hbhs-faq-item" data-search="calendrier horaire fuseau">
            <button class="hbhs-faq-q" type="button" aria-expanded="false">
              Mes horaires ne sont pas bons dans le calendrier.
              <span>+</span>
            </button>
            <div class="hbhs-faq-a">
              Controle le fuseau horaire du navigateur et du compte. Ensuite actualise la page calendrier.
            </div>
          </div>
          <div class="hbhs-faq-item" data-search="commentaire post actualites like">
            <button class="hbhs-faq-q" type="button" aria-expanded="false">
              Je ne vois pas mes commentaires dans le feed.
              <span>+</span>
            </button>
            <div class="hbhs-faq-a">
              Recharge le feed puis ouvre "Voir commentaires". Si ca persiste, signale avec l'ID du post.
            </div>
          </div>
        </section>

        <section class="hbhs-faq-group" id="faq-paiement" data-group-title="paiement wallet points facturation">
          <h3>Paiement & wallet</h3>
          <div class="hbhs-faq-item" data-search="wallet points solde">
            <button class="hbhs-faq-q" type="button" aria-expanded="false">
              Mon solde wallet/points ne se met pas a jour.
              <span>+</span>
            </button>
            <div class="hbhs-faq-a">
              Actualise la page wallet. Si le paiement est recent, attends la confirmation puis recharge.
            </div>
          </div>
          <div class="hbhs-faq-item" data-search="paiement refuse carte">
            <button class="hbhs-faq-q" type="button" aria-expanded="false">
              Paiement refuse, comment proceder ?
              <span>+</span>
            </button>
            <div class="hbhs-faq-a">
              Verifie les infos carte, plafond, puis reessaie. Sinon utilise un autre moyen de paiement.
            </div>
          </div>
          <div class="hbhs-faq-item" data-search="facture recu justificatif">
            <button class="hbhs-faq-q" type="button" aria-expanded="false">
              Ou recuperer ma facture ?
              <span>+</span>
            </button>
            <div class="hbhs-faq-a">
              Va dans Wallet/Historique et ouvre la transaction. Tu peux ensuite telecharger le justificatif.
            </div>
          </div>
        </section>

        <section class="hbhs-faq-group" id="faq-technique" data-group-title="bug erreur api support technique">
          <h3>Support technique</h3>
          <div class="hbhs-faq-item" data-search="erreur 401 404 429 api">
            <button class="hbhs-faq-q" type="button" aria-expanded="false">
              Que signifient les erreurs 401/404/429 ?
              <span>+</span>
            </button>
            <div class="hbhs-faq-a">
              401: session/token non valide. 404: route/page introuvable. 429: trop de requetes en peu de temps.
            </div>
          </div>
          <div class="hbhs-faq-item" data-search="image upload mixed content minio">
            <button class="hbhs-faq-q" type="button" aria-expanded="false">
              Mes images ne s'affichent pas apres upload.
              <span>+</span>
            </button>
            <div class="hbhs-faq-a">
              Utilise l'upload via proxy HTTPS. Evite les URLs internes non publiques (localhost, minio local).
            </div>
          </div>
          <div class="hbhs-faq-item" data-search="cache navigateur wordpress cdn">
            <button class="hbhs-faq-q" type="button" aria-expanded="false">
              Comment vider le cache correctement ?
              <span>+</span>
            </button>
            <div class="hbhs-faq-a">
              Vider cache navigateur + cache WordPress + cache CDN si actif, puis faire un hard refresh.
            </div>
          </div>
        </section>
      </article>
    </main>

    <aside class="hbhs-side">
      <article class="hbhs-card">
        <header class="hbhs-card-head">
          <h2>Canaux support</h2>
          <p>Choisis le meilleur canal selon l'urgence.</p>
        </header>
        <div class="hbhs-contact-list">
          <a class="hbhs-contact" href="mailto:support@homebook.ma">
            <strong>Email support</strong>
            <span>support@homebook.ma</span>
          </a>
          <a class="hbhs-contact" href="mailto:billing@homebook.ma">
            <strong>Facturation</strong>
            <span>billing@homebook.ma</span>
          </a>
          <div class="hbhs-contact">
            <strong>Delai moyen</strong>
            <span>1 a 24h selon priorite</span>
          </div>
        </div>
      </article>

      <article class="hbhs-card">
        <header class="hbhs-card-head">
          <h2>Ouvrir un ticket</h2>
          <p>Envoi API + sauvegarde locale de secours.</p>
        </header>
        <div class="hbhs-form">
          <label>
            Sujet
            <input id="hbhs-subject" type="text" placeholder="Ex: Erreur 429 sur notifications" />
          </label>
          <label>
            Priorite
            <select id="hbhs-priority">
              <option value="basse">Basse</option>
              <option value="normale" selected>Normale</option>
              <option value="haute">Haute</option>
              <option value="critique">Critique</option>
            </select>
          </label>
          <label>
            Description
            <textarea id="hbhs-message" rows="5" placeholder="Decris les etapes pour reproduire le probleme..."></textarea>
          </label>
          <div class="hbhs-actions">
            <button id="hbhs-save" class="hbhs-btn primary" type="button">Enregistrer</button>
            <button id="hbhs-copy" class="hbhs-btn" type="button">Copier le ticket</button>
          </div>
          <p id="hbhs-feedback" class="hbhs-feedback"></p>
          <div class="hbhs-ticket-box">
            <div class="hbhs-ticket-title">Suivi des tickets</div>
            <div id="hbhs-ticket-list" class="hbhs-ticket-list"></div>
          </div>
        </div>
      </article>
    </aside>
  </section>
</div>

<style>
  #hb-help-support.hbhs {
    --bg: #f4f7fd;
    --card: #ffffff;
    --ink: #0f2742;
    --muted: #5e738f;
    --line: #dce7f7;
    --primary: #0f3b67;
    --primary-2: #174f86;
    --accent: #245f9f;
    --ok: #0f8f60;
    --danger: #be2f3f;
    --radius: 18px;
    --shadow: 0 16px 40px rgba(11, 36, 68, 0.09);
    --shadow-sm: 0 8px 24px rgba(11, 36, 68, 0.07);
    font-family: "Inter", "Segoe UI", Arial, sans-serif;
    color: var(--ink);
    width: 100vw !important;
    max-width: none !important;
    margin-left: calc(50% - 50vw) !important;
    margin-right: calc(50% - 50vw) !important;
    padding: 24px clamp(14px, 3vw, 40px) 60px;
    background:
      radial-gradient(900px 380px at -10% -20%, rgba(23, 79, 134, 0.14), transparent 58%),
      radial-gradient(900px 380px at 110% -20%, rgba(15, 59, 103, 0.12), transparent 58%),
      var(--bg);
  }

  /* WP/Divi containers often clamp child width to 1080px; force full-bleed */
  .et_pb_module #hb-help-support.hbhs,
  .et_pb_text_inner #hb-help-support.hbhs,
  #main-content #hb-help-support.hbhs {
    width: 100vw !important;
    max-width: none !important;
    margin-left: calc(50% - 50vw) !important;
    margin-right: calc(50% - 50vw) !important;
  }

  #hb-help-support * { box-sizing: border-box; }

  #hb-help-support .hbhs-hero {
    background: linear-gradient(145deg, #ffffff, #f8fbff);
    border: 1px solid var(--line);
    border-radius: 22px;
    box-shadow: var(--shadow);
    padding: 20px;
    display: grid;
    grid-template-columns: 1.15fr 0.85fr;
    gap: 18px;
  }

  #hb-help-support .hbhs-kicker {
    margin: 0 0 8px;
    text-transform: uppercase;
    font-size: 12px;
    letter-spacing: 0.14em;
    color: var(--accent);
    font-weight: 800;
  }

  #hb-help-support h1 {
    margin: 0;
    font-size: clamp(27px, 4vw, 38px);
    line-height: 1.05;
    letter-spacing: -0.03em;
    color: var(--primary);
  }

  #hb-help-support .hbhs-sub {
    margin: 10px 0 0;
    max-width: 62ch;
    font-size: 14px;
    line-height: 1.6;
    color: var(--muted);
  }

  #hb-help-support .hbhs-search-wrap {
    display: grid;
    gap: 8px;
    font-size: 13px;
    font-weight: 700;
    color: var(--primary);
  }

  #hb-help-support .hbhs-search-wrap input {
    width: 100%;
    border: 1px solid #c7d9f1;
    border-radius: 12px;
    background: #fff;
    padding: 12px 13px;
    font-size: 14px;
    color: var(--ink);
    outline: none;
  }

  #hb-help-support .hbhs-search-wrap input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 4px rgba(36, 95, 159, 0.16);
  }

  #hb-help-support .hbhs-grid {
    margin-top: 14px;
    display: grid;
    grid-template-columns: 1.15fr 0.85fr;
    gap: 14px;
    align-items: start;
  }

  #hb-help-support .hbhs-card {
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }

  #hb-help-support .hbhs-card-head {
    padding: 14px 14px 10px;
    border-bottom: 1px solid var(--line);
    background: linear-gradient(180deg, #ffffff, #f9fcff);
  }

  #hb-help-support .hbhs-card-head h2 {
    margin: 0;
    font-size: 17px;
    color: var(--primary);
    letter-spacing: -0.01em;
  }

  #hb-help-support .hbhs-card-head p {
    margin: 6px 0 0;
    font-size: 13px;
    color: var(--muted);
    line-height: 1.45;
  }

  #hb-help-support .hbhs-quick {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 12px 14px 14px;
  }

  #hb-help-support .hbhs-chip {
    text-decoration: none;
    padding: 8px 10px;
    border-radius: 999px;
    border: 1px solid #cfe0f6;
    background: #f4f9ff;
    color: var(--primary);
    font-size: 12px;
    font-weight: 800;
  }

  #hb-help-support .hbhs-chip:hover {
    background: #e9f3ff;
  }

  #hb-help-support .hbhs-faq-group {
    padding: 12px 14px 2px;
    border-bottom: 1px dashed #dce8f7;
  }

  #hb-help-support .hbhs-faq-group:last-child {
    border-bottom: 0;
    padding-bottom: 14px;
  }

  #hb-help-support .hbhs-faq-group h3 {
    margin: 0 0 8px;
    font-size: 14px;
    color: var(--primary);
  }

  #hb-help-support .hbhs-faq-item {
    border: 1px solid #d5e4f7;
    background: #fbfdff;
    border-radius: 12px;
    margin-bottom: 9px;
    overflow: hidden;
  }

  #hb-help-support .hbhs-faq-q {
    border: 0;
    background: transparent;
    width: 100%;
    text-align: left;
    cursor: pointer;
    padding: 12px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 14px;
    font-size: 14px;
    color: var(--ink);
    font-weight: 700;
  }

  #hb-help-support .hbhs-faq-q span {
    font-size: 19px;
    line-height: 1;
    color: var(--accent);
  }

  #hb-help-support .hbhs-faq-a {
    display: none;
    padding: 0 12px 12px;
    font-size: 13px;
    line-height: 1.6;
    color: var(--muted);
  }

  #hb-help-support .hbhs-faq-item.open .hbhs-faq-a {
    display: block;
  }

  #hb-help-support .hbhs-faq-item.open .hbhs-faq-q {
    border-bottom: 1px solid #dfebf9;
  }

  #hb-help-support .hbhs-faq-item.open .hbhs-faq-q span {
    transform: rotate(45deg);
  }

  #hb-help-support .hbhs-side {
    display: grid;
    gap: 12px;
  }

  #hb-help-support .hbhs-contact-list {
    padding: 12px 14px 14px;
    display: grid;
    gap: 8px;
  }

  #hb-help-support .hbhs-contact {
    display: grid;
    gap: 4px;
    padding: 11px;
    border: 1px solid #d5e4f7;
    background: #fbfdff;
    border-radius: 12px;
    color: var(--ink);
    text-decoration: none;
  }

  #hb-help-support .hbhs-contact strong {
    font-size: 13px;
    color: var(--primary);
  }

  #hb-help-support .hbhs-contact span {
    font-size: 12px;
    color: var(--muted);
  }

  #hb-help-support .hbhs-form {
    padding: 12px 14px 14px;
    display: grid;
    gap: 10px;
  }

  #hb-help-support .hbhs-form label {
    display: grid;
    gap: 6px;
    font-size: 12px;
    color: var(--primary);
    font-weight: 700;
  }

  #hb-help-support .hbhs-form input,
  #hb-help-support .hbhs-form select,
  #hb-help-support .hbhs-form textarea {
    width: 100%;
    border: 1px solid #c7d9f1;
    background: #fff;
    color: var(--ink);
    border-radius: 11px;
    padding: 11px;
    font-size: 14px;
    outline: none;
  }

  #hb-help-support .hbhs-form input:focus,
  #hb-help-support .hbhs-form select:focus,
  #hb-help-support .hbhs-form textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 4px rgba(36, 95, 159, 0.16);
  }

  #hb-help-support .hbhs-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  #hb-help-support .hbhs-btn {
    border: 1px solid #c5d8f1;
    background: #f4f9ff;
    color: var(--primary);
    border-radius: 11px;
    padding: 10px 12px;
    font-size: 13px;
    font-weight: 800;
    cursor: pointer;
  }

  #hb-help-support .hbhs-btn.primary {
    border-color: #1f5e9f;
    background: linear-gradient(180deg, #1a5b9b, #124a81);
    color: #fff;
  }

  #hb-help-support .hbhs-feedback {
    min-height: 19px;
    margin: 2px 0 0;
    font-size: 12px;
    font-weight: 700;
    color: var(--muted);
  }

  #hb-help-support .hbhs-feedback.ok { color: var(--ok); }
  #hb-help-support .hbhs-feedback.err { color: var(--danger); }

  #hb-help-support .hbhs-ticket-box {
    margin-top: 2px;
    border: 1px solid #d5e4f7;
    border-radius: 12px;
    background: #fbfdff;
    padding: 10px;
  }

  #hb-help-support .hbhs-ticket-title {
    font-size: 12px;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 7px;
  }

  #hb-help-support .hbhs-ticket-list {
    display: grid;
    gap: 7px;
  }

  #hb-help-support .hbhs-ticket-item {
    border: 1px solid #dce8f7;
    background: #fff;
    border-radius: 10px;
    padding: 8px;
    display: grid;
    gap: 5px;
  }

  #hb-help-support .hbhs-ticket-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
  }

  #hb-help-support .hbhs-ticket-subject {
    font-size: 12px;
    font-weight: 800;
    color: var(--ink);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  #hb-help-support .hbhs-ticket-meta {
    font-size: 11px;
    color: var(--muted);
  }

  #hb-help-support .hbhs-status {
    font-size: 10px;
    line-height: 1;
    font-weight: 800;
    border-radius: 999px;
    border: 1px solid #d5e4f7;
    padding: 5px 7px;
    color: var(--primary);
    background: #f4f9ff;
    text-transform: uppercase;
    letter-spacing: .04em;
  }

  #hb-help-support .hbhs-status.open {
    color: #1f5e9f;
    border-color: #cfe0f6;
    background: #eaf3ff;
  }

  #hb-help-support .hbhs-status.in_progress {
    color: #8a5800;
    border-color: #efd89e;
    background: #fff7dd;
  }

  #hb-help-support .hbhs-status.resolved,
  #hb-help-support .hbhs-status.closed {
    color: #0a6b47;
    border-color: #b9e4d1;
    background: #eafaf2;
  }

  #hb-help-support .hbhs-empty {
    padding: 12px;
    border: 1px dashed #d3e3f8;
    border-radius: 12px;
    background: #fbfdff;
    color: var(--muted);
    font-size: 13px;
  }

  @media (max-width: 980px) {
    #hb-help-support .hbhs-hero,
    #hb-help-support .hbhs-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  (function () {
    if (window.__HB_HELP_SUPPORT_INIT__) return;
    window.__HB_HELP_SUPPORT_INIT__ = true;

    const root = document.getElementById("hb-help-support");
    if (!root) return;

    const HB = window.HB_CONFIG || {};
    const searchInput = root.querySelector("#hbhs-search");
    const groups = Array.from(root.querySelectorAll(".hbhs-faq-group"));
    const faqItems = Array.from(root.querySelectorAll(".hbhs-faq-item"));
    const saveBtn = root.querySelector("#hbhs-save");
    const copyBtn = root.querySelector("#hbhs-copy");
    const subjectEl = root.querySelector("#hbhs-subject");
    const priorityEl = root.querySelector("#hbhs-priority");
    const messageEl = root.querySelector("#hbhs-message");
    const feedbackEl = root.querySelector("#hbhs-feedback");
    const ticketListEl = root.querySelector("#hbhs-ticket-list");

    const LS_KEY = "hb_help_support_ticket";
    const TOKEN = String(HB.token || "").trim();

    function normalizeApiBase(raw) {
      const b = String(raw || "").trim().replace(/\/+$/, "");
      if (!b) return "/api/v1";
      if (/\/api\/v1$/i.test(b)) return b;
      if (/\/api$/i.test(b)) return b + "/v1";
      if (/^https?:\/\//i.test(b) || b.startsWith("/")) return b + "/api/v1";
      return "/api/v1";
    }

    const API_BASE = normalizeApiBase(HB.apiBase || root.getAttribute("data-api-base") || "");

    function apiUrl(path) {
      const p = String(path || "").startsWith("/") ? String(path) : ("/" + String(path || ""));
      return API_BASE + p;
    }

    async function api(path, options) {
      const opts = options || {};
      const headers = Object.assign({ Accept: "application/json" }, opts.headers || {});
      if (TOKEN) {
        if (!headers.Authorization) headers.Authorization = "Bearer " + TOKEN;
        if (!headers["X-HB-Token"]) headers["X-HB-Token"] = TOKEN;
      }

      const res = await fetch(apiUrl(path), {
        method: opts.method || "GET",
        headers: headers,
        credentials: "same-origin",
        body: opts.body || undefined
      });

      const text = await res.text().catch(function () { return ""; });
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch (_e) { data = null; }

      if (!res.ok) {
        const msg = (data && data.detail) ? String(data.detail) : ("HTTP " + res.status);
        const err = new Error(msg);
        err.status = res.status;
        throw err;
      }

      return data;
    }

    function esc(v) {
      return String(v == null ? "" : v)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function setFeedback(text, kind) {
      feedbackEl.textContent = text || "";
      feedbackEl.className = "hbhs-feedback" + (kind ? " " + kind : "");
    }

    function closeAllFaq() {
      faqItems.forEach(function (item) {
        item.classList.remove("open");
        const btn = item.querySelector(".hbhs-faq-q");
        if (btn) btn.setAttribute("aria-expanded", "false");
      });
    }

    faqItems.forEach(function (item) {
      const btn = item.querySelector(".hbhs-faq-q");
      if (!btn) return;
      btn.addEventListener("click", function () {
        const isOpen = item.classList.contains("open");
        closeAllFaq();
        if (!isOpen) {
          item.classList.add("open");
          btn.setAttribute("aria-expanded", "true");
        }
      });
    });

    function normalize(s) {
      return String(s || "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim();
    }

    function applySearch() {
      const q = normalize(searchInput.value);
      let anyVisible = false;

      groups.forEach(function (group) {
        const titleKey = normalize(group.getAttribute("data-group-title") || "");
        let groupVisible = false;
        const items = Array.from(group.querySelectorAll(".hbhs-faq-item"));

        items.forEach(function (item) {
          const itemText = normalize(item.innerText);
          const itemSearch = normalize(item.getAttribute("data-search") || "");
          const match = !q || titleKey.includes(q) || itemText.includes(q) || itemSearch.includes(q);
          item.style.display = match ? "" : "none";
          if (match) groupVisible = true;
        });

        group.style.display = groupVisible ? "" : "none";
        if (groupVisible) anyVisible = true;
      });

      let empty = root.querySelector(".hbhs-main .hbhs-empty");
      if (!anyVisible) {
        if (!empty) {
          empty = document.createElement("div");
          empty.className = "hbhs-empty";
          empty.textContent = "Aucune reponse trouvee pour cette recherche.";
          const faqCard = root.querySelector(".hbhs-main .hbhs-card:last-child");
          faqCard.appendChild(empty);
        }
      } else if (empty) {
        empty.remove();
      }
    }

    searchInput.addEventListener("input", applySearch);

    function readSaved() {
      try {
        return JSON.parse(localStorage.getItem(LS_KEY) || "null");
      } catch (_e) {
        return null;
      }
    }

    function statusLabel(status) {
      const s = String(status || "open").toLowerCase();
      if (s === "in_progress") return "En cours";
      if (s === "resolved") return "Resolue";
      if (s === "closed") return "Fermee";
      return "Ouverte";
    }

    function formatDate(iso) {
      try {
        const d = new Date(iso);
        if (String(d) === "Invalid Date") return "date inconnue";
        return d.toLocaleString("fr-FR", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit"
        });
      } catch (_e) {
        return "date inconnue";
      }
    }

    function renderTicketHistory(rows) {
      if (!ticketListEl) return;
      if (!Array.isArray(rows) || !rows.length) {
        ticketListEl.innerHTML = '<div class="hbhs-empty">Aucun ticket envoye.</div>';
        return;
      }

      ticketListEl.innerHTML = rows.map(function (row) {
        const status = String(row.status || "open").toLowerCase();
        return (
          '<article class="hbhs-ticket-item">' +
            '<div class="hbhs-ticket-top">' +
              '<div class="hbhs-ticket-subject">#' + esc(row.id) + " - " + esc(row.subject || "Ticket") + "</div>" +
              '<span class="hbhs-status ' + esc(status) + '">' + esc(statusLabel(status)) + "</span>" +
            "</div>" +
            '<div class="hbhs-ticket-meta">Priorite: ' + esc(row.priority || "normale") + " - " + esc(formatDate(row.created_at)) + "</div>" +
          "</article>"
        );
      }).join("");
    }

    async function loadTicketHistory() {
      if (!ticketListEl) return;
      ticketListEl.innerHTML = '<div class="hbhs-empty">Chargement...</div>';

      try {
        const data = await api("/help/tickets?limit=6");
        const rows = Array.isArray(data) ? data : (Array.isArray(data && data.items) ? data.items : []);
        renderTicketHistory(rows);
      } catch (e) {
        if (e && (e.status === 401 || e.status === 403)) {
          ticketListEl.innerHTML = '<div class="hbhs-empty">Connecte-toi pour suivre tes tickets.</div>';
          return;
        }
        ticketListEl.innerHTML = '<div class="hbhs-empty">Historique indisponible.</div>';
      }
    }

    async function saveTicket() {
      const subject = String(subjectEl.value || "").trim();
      const message = String(messageEl.value || "").trim();
      const priority = String(priorityEl.value || "normale");

      if (subject.length < 4) {
        setFeedback("Sujet trop court (min 4 caracteres).", "err");
        return;
      }
      if (message.length < 12) {
        setFeedback("Description trop courte (min 12 caracteres).", "err");
        return;
      }

      const payload = {
        subject: subject,
        priority: priority,
        message: message,
        page: window.location.href,
        source: "help_support_form"
      };

      saveBtn.disabled = true;
      try {
        const created = await api("/help/tickets", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        localStorage.setItem(LS_KEY, JSON.stringify({
          subject: subject,
          priority: priority,
          message: message,
          created_at: new Date().toISOString(),
          ticket_id: created && created.id ? Number(created.id) : null
        }));

        const suffix = (created && created.id) ? (" #" + created.id) : "";
        setFeedback("Ticket envoye" + suffix + ".", "ok");
        await loadTicketHistory();
      } catch (e) {
        localStorage.setItem(LS_KEY, JSON.stringify({
          subject: subject,
          priority: priority,
          message: message,
          created_at: new Date().toISOString(),
          local_only: true
        }));
        setFeedback("API indisponible, ticket garde en local: " + (e.message || "Erreur"), "err");
      } finally {
        saveBtn.disabled = false;
      }
    }

    function copyTicket() {
      const subject = String(subjectEl.value || "").trim();
      const message = String(messageEl.value || "").trim();
      const priority = String(priorityEl.value || "normale");
      const body = [
        "HomeBook - Ticket Support",
        "Sujet: " + subject,
        "Priorite: " + priority,
        "Page: " + window.location.href,
        "",
        "Description:",
        message
      ].join("\n");

      if (!subject || !message) {
        setFeedback("Remplis d'abord le sujet et la description.", "err");
        return;
      }

      navigator.clipboard.writeText(body).then(function () {
        setFeedback("Ticket copie dans le presse-papiers.", "ok");
      }).catch(function () {
        setFeedback("Impossible de copier automatiquement. Copie manuelle requise.", "err");
      });
    }

    saveBtn.addEventListener("click", saveTicket);
    copyBtn.addEventListener("click", copyTicket);

    const saved = readSaved();
    if (saved) {
      subjectEl.value = saved.subject || "";
      priorityEl.value = saved.priority || "normale";
      messageEl.value = saved.message || "";
      if (saved.ticket_id) {
        setFeedback("Dernier ticket recharge (#" + saved.ticket_id + ").", "");
      } else {
        setFeedback("Dernier ticket local recharge.", "");
      }
    }

    loadTicketHistory();
  })();
</script>
